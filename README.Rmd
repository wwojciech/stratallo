---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

\def\R{{\mathbb R}}
\def\x{\mathbf x}
\def\n{\mathbf n}
\def\D{\widetilde D}
\newcommand{\texteq}{\mathrm}

# Optimum Sample Allocation in Stratified Sampling with `stratallo` Package

<!-- badges: start -->
<!-- badges: end -->

Functions in this package provide solution to classical problem in survey
methodology - an optimum sample allocation in stratified sampling schemes. In
this context, the optimal allocation is in the classical Tschuprov-Neyman's
sense and it satisfies additional lower or upper bounds restrictions imposed on
sample sizes in strata. There are few different algorithms available to use, and
one them is based on popular sample allocation method that applies Neyman
allocation to recursively reduced set of strata.

A minor modification of the classical optimum sample allocation problem leads
to the minimum cost allocation. This problem lies in the determination of a
vector of strata sample sizes that minimizes total cost of the survey, under
assumed fixed level of the stratified $\pi$-estimator's variance. As in the case
of the classical optimum allocation, the problem of minimum cost allocation can
be complemented by imposing upper bounds on sample sizes in strata.
  
*stratallo* provides two **user functions**:

* `opt()`
* `optcost()`

that solve sample allocation problems briefly characterized above. In this
context, it is assumed that the variance of the stratified estimator is of the
following generic form:
$$
  V_{st}(\n) = \sum_{h=1}^{H} \frac{A_h^2}{n_h} - A_0,
$$
where $H$ denotes total number of strata, $\n = (n_h)_{h \in \{1,\ldots,H\}}$ is
the allocation vector with strata sample sizes, and population parameters $A_0$,
and $A_h > 0,\, h = 1,\ldots,H$, do not depend on the $x_h,\, h = 1,\ldots,H$.

Among stratified estimators and stratified sampling designs that jointly give
rise to a variance of the above form, is the so called stratified $\pi$
estimator of the population total with *stratified simple random sampling
without replacement* design, which is one of the most basic and commonly used
stratified sampling designs. This case yields
$A_0 = \sum_{h = 1}^H N_h S_h^2$, $A_h = N_h S_h,\, h = 1,\ldots,H$, where
$S_h$ denotes stratum standard deviation of study variable and $N_h$ is the
stratum size (see e.g. @sarndal, Result 3.7.2, p.103).

Apart from `opt()` and `optcost()`, *stratallo* provides the following
**helpers functions**:

* `var_st()`,
* `var_st_tsi()`,
* `asummary()`,
* `ran_round()`,
* `round_oric()`.

Functions `var_st()` and `var_st_tsi()` compute a value of the variance $V_{st}$.
The `var_st_tsi()` is a simple wrapper of `var_st()` that is dedicated for the
case when $A_0 = \sum_{h = 1}^H N_h S_h^2$ and $A_h = N_h S_h,\, h = 1,\ldots,H$.
`asummary()` creates a `data.frame` object with summary of the allocation.
Functions `ran_round()` and `round_oric()` are the rounding functions that can
be used to round non-integers allocations (see section Rounding, below).
The package comes with three predefined, artificial populations with 10, 507
and 969 strata. These are stored under `pop10_mM`, pop507` and `pop969` objects,
respectively.

See package's vignette for more details.

## Installation

You can install the released version of *stratallo* package from
[CRAN](https://CRAN.R-project.org) with:

``` r
install.packages("stratallo")
```

## Examples

These are basic examples that show how to use `opt()` and `optcost()` functions
to solve different versions of optimum sample allocation problem for an example
population with 4 strata.

```{r load_package}
library(stratallo)
```

Define example population

```{r pop}
N <- c(3000, 4000, 5000, 2000) # Strata sizes.
S <- c(48, 79, 76, 16) # Standard deviations of a study variable in strata.
a <- N * S
n <- 190 # Total sample size.
```

Tschuprov-Neyman allocation (no inequality constraints).

```{r opt_Neyman}
opt <- opt(n = n, a = a)
opt
sum(opt) == n
# Variance of the stratified estimator that corresponds to optimum allocation.
var_st_tsi(opt, N, S)
```

One-sided upper-bounds constraints.

```{r opt_M}
M <- c(100, 90, 70, 80) # Upper bounds imposed on the sample sizes in strata.
all(M <= N)
n <= sum(M)

opt <- opt(n = n, a = a, M = M)
opt
sum(opt) == n
all(opt <= M) # Does not violate upper-bounds constraints.
# Variance of the stratified estimator that corresponds to optimum allocation.
var_st_tsi(opt, N, S)
```

One-sided lower-bounds constraints.

```{r opt_m}
m <- c(50, 120, 1, 2) # Lower bounds imposed on the sample sizes in strata.
n >= sum(m)

opt <- opt(n = n, a = a, m = m)
opt
sum(opt) == n
all(opt >= m) # Does not violate lower-bounds constraints.
# Variance of the stratified estimator that corresponds to optimum allocation.
var_st_tsi(opt, N, S)
```

Box constraints.

```{r opt_box}
m <- c(100, 90, 500, 50) # Lower bounds imposed on sample sizes in strata.
M <- c(300, 400, 800, 90) # Upper bounds imposed on sample sizes in strata.
n <- 1284
n >= sum(m) && n <= sum(M)

opt <- opt(n = n, a = a, m = m, M = M)
opt
sum(opt) == n
all(opt >= m & opt <= M) # Does not violate any lower or upper bounds constraints.
# Variance of the stratified estimator that corresponds to optimum allocation.
var_st_tsi(opt, N, S)
```

Minimization of the total cost with `optcost()` function

```{r optcost}
a <- c(3000, 4000, 5000, 2000)
a0 <- 70000
unit_costs <- c(0.5, 0.6, 0.6, 0.3) # c_h, h = 1,...4.
M <- c(100, 90, 70, 80)
V <- 1e6 # Variance constraint.
V >= sum(a^2 / M) - a0

opt <- optcost(V = V, a = a, a0 = a0, M = M, unit_costs = unit_costs)
opt
sum(a^2 / opt) - a0 == V
all(opt <= M)
```

Rounding.

```{r rounding}
m <- c(100, 90, 500, 50)
M <- c(300, 400, 800, 90)
n <- 1284

# Optimum, non-integer allocation under box constraints.
opt <- opt(n = n, a = a, m = m, M = M)
opt

opt_int <- round_oric(opt)
opt_int
```
